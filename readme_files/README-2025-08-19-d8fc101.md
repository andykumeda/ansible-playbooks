## Project Overview

This is an Ansible automation repository for managing Cisco network infrastructure, primarily IOS switches and routers. The project automates configuration management, user provisioning, port mapping, and network device setup across multiple locations (VDM, MPOE, Baxter, etc.).

## Common Commands

### Running Playbooks
- **Full site configuration**: `ansible-playbook -i inventory/vdm playbooks/site.yml`
- **User management only**: `ansible-playbook -i inventory/vdm playbooks/site.yml --tags users`
- **Common configuration only**: `ansible-playbook -i inventory/vdm playbooks/site.yml --tags common`
- **SNMP configuration only**: `ansible-playbook -i inventory/vdm playbooks/site.yml --tags snmp`

### Running Individual Playbooks
- **User management**: `ansible-playbook -i inventory/vdm playbooks/users.yml`
- **Port bouncing**: `ansible-playbook -i inventory/switches -l 10.151.26.1 playbooks/bounce-ports.yml -vvvv -e vlan_id=28`
- **Basic connectivity test**: `ansible-playbook -i inventory/vdm playbooks/test.yml`
- **Configuration backup**: `ansible-playbook -i inventory/vdm playbooks/fetch_config.yml`

### Common Options
- **Limit to specific host**: `-l hostname` or `-l ip_address`
- **Verbose debugging**: `-vvvv` 
- **Pass variables**: `-e variable_name=value`

### Inventory Selection
- Use location-specific inventory files: `inventory/vdm`, `inventory/mpoe`, `inventory/2e39`, `inventory/lab`, etc.
- YAML inventory files for complex configs: `inventory/baxter.yml`, `inventory/vxrail.yml`, `inventory/c9410.yml`
- The default inventory is set to `inventory/hosts` in `ansible.cfg`

### Vault Operations
- Vault password file is configured as `.vault_pass.txt`
- Encrypt sensitive strings: `ansible-vault encrypt_string 'password_to_encrypt' --name 'variable_name'`

## Architecture and Structure

### Directory Layout
- `inventory/`: Contains host definitions organized by location
  - Text files (e.g., `vdm`, `mpoe`) contain simple host lists in INI format
  - YAML files (e.g., `baxter.yml`, `vxrail.yml`) for more complex configurations
- `playbooks/`: Ansible playbooks and related files
  - `group_vars/`: Global variables and user definitions
  - `keyfiles/`: SSH public keys for user authentication
- `ansible.cfg`: Main Ansible configuration with vault and connection settings

### Key Playbooks
- `site.yml`: Main orchestration playbook that imports all others
- `common.yml`: Standard device configuration (banners, NTP, DNS, system settings)
- `users.yml`: User account management with SSH keys and password hashes
- `snmpv3.yml`: SNMP v3 configuration
- `logging.yml`: Syslog configuration for centralized logging
- `test.yml`: Basic connectivity test (`show version | incl Version`)
- **Port management**: `bounce-ports.yml`, `port-mapper.yml`, `name-ports.yml`, `ip-port.yml`
- **Configuration backup**: `fetch_config.yml`, `get_config.yml`
- **Password management**: `passchange.yml` (includes validation test)
- **User management**: `remove_pubkey.yml`, `rename_user.yml`

### Variable Management
- `playbooks/group_vars/all`: Global variables for all devices (credentials, NTP, DNS, SNMP)
- `playbooks/group_vars/users`: User account definitions with SSH keys and password hashes
- Sensitive data is encrypted with Ansible Vault

### Connection Configuration
- Uses `network_cli` connection type for Cisco IOS devices
- Default username: `ansible` with privilege escalation via `enable`
- SSH key checking disabled for lab environments
- Connection timeout: 5 seconds, task timeout: 300 seconds

### Device Types
- **Switches**: Grouped as `[switches]` - receive VTP transparent mode configuration
- **Routers**: Grouped as `[routers]` - skip switch-specific configurations
- All devices receive common configuration (NTP, DNS, banners, users, SNMP)

### User Management
- SSH key-based authentication for admin users (kumedaa, kumeda, simpsona, garnicag)
- Password-based accounts (hcaitadmin, itsdadmin) with hashed passwords
- Automatic cleanup of users not defined in the configuration

## Troubleshooting Notes

### SSH Connection Issues
- If getting "ansible-pylibssh not installed" warnings, install with `pip3 install ansible-pylibssh`
- May need to rename `/usr/lib/python3.XX/EXTERNALLY-MANAGED` first
- Add `PubkeyAcceptedKeyTypes +ssh-rsa` to SSH config if needed

### Device Initial Setup
- Devices must have enable secret configured for SSH to work
- Username `ansible` with privilege 15 and hashed password must be pre-configured
- IP configuration and SSH access must be established before running Ansible
- Enable secret example: `enable secret 9 $9$HGBaybiQW50LVU$2axG6jYj/rgSI42Rl1ahrpR2eVY0q3OmZStW03RyyXE`

#### Initial Configuration Steps
1. **Initial Setup Dialog**: Answer "no" when prompted for initial configuration dialog
2. **Enable Secret**: Configure enable secret (required for SSH access)
3. **User Account**: Create ansible user with privilege 15 and hashed password:
   - Current: `username ansible priv 15 secret 9 $9$AibezzbEW27Q9U$RV3VYe1QJEEHAFSC5FIhaoLbMs7JicEuAoDiVwHI9OQ`
   - Backup admin: `username hcaitadmin privilege 15 secret 9 $9$ZQ0Ryt3JPpc1Pk$qZL5UMDPYfR2gZDVtYEK.Xik6lfCZSLxSJIXNN1lb7s`
4. **SSH Configuration**:
   ```
   line vty 0 15
   login local
   transport input ssh
   ```
5. **Network Connectivity**: Configure interface with IP address and routing:
   ```
   interface vlan X
   ip address x.x.x.x y.y.y.y
   no shut
   ip route 0.0.0.0 0.0.0.0 x.x.x.1
   ```

### CSV Processing and Port Mapping
- Port mapping functionality uses CSV files (Port-Matrix.csv variants)
- DHCP port mapping available via `dhcp_port_mapping.csv`
- Use `ip-port.yml` to gather IP, MAC, VLAN, and port details
- Port configuration from CSV data handled by `name-ports.yml`

### Testing and Validation
- Use `test.yml` for basic connectivity testing
- Password changes include automatic validation via reconnection test
- Run with `-vvvv` for detailed debugging output
- Limit operations to specific devices with `-l hostname` or `-l ip_address`

## Additional Resources

### SSH Best Practices
- Reference: [IOS XE SSH Best Practices](https://mrncciew.com/2023/08/28/ios-xe-ssh-best-practices/)
- May require SSH key type configuration for older devices

### Archived Files
- Obsolete/test files are stored in `.old/` directory
- Includes deprecated playbooks, test CSVs, and old configurations
